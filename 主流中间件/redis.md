# Redis知识点整理
## 1、持久化机制
- `RDB`方式：定期将内存中的数据以快照的形式保存到硬盘的二进制文件中
- `AOF`方式：将每一个收到的命令都追加到文件最后，类似于MySQL的binlog,重启时会通过执行文件中保存的写命令在内存中重建整个数据库内容。

两种方式同时开启时，数据恢复会优先选择AOF恢复

## 2、单线程的Redis为什么快

- 纯内存操作
- 单线程，避免了频繁的上下文切换
- 采用了非阻塞I/O的多路复用机制
  
## 3、内存淘汰策略
- `noeviction` (默认策略)：对写请求不再提供服务，直接返回错误(DEL请求和部分特殊请求除外)
- `allkeys-lru` ：从所有key中使用LRU算法进行淘汰
- `volatile-lru` ：从设置了过期时间的key中使用LRU算法进行淘汰
- `allkeys-random` ：从所有key中随机淘汰数据
- `volatile-random` ：从设置了过期时间的key中随机淘汰
- `volatile-ttl` ：在设置了过期时间的key中，根据key的过期时间进行淘汰，越早过期的越优先被淘汰

LRU(Least Recently Used)，即最近最少使用。

### 配置内存淘汰策略
- 1.修改redis.conf文件
```
//设置Redis最大占用内存大小为100M
maxmemory 100mb
//设置内存淘汰策略
maxmemory-policy allkeys-lru
```
- 2.通过命令行直接查看/修改
```
//获取Redis最大占用内存
127.0.0.1:6379> config get maxmemory
//设置Redis最大占用内存
127.0.0.1:6379> config set maxmemory 100mb
//获取Redis内存淘汰策略
127.0.0.1:6379> config get maxmemory-policy
//设置Redis内存淘汰策略
127.0.0.1:6379> config set maxmemory-policy allkeys-lru
```

## 4、缓存雪崩，击穿，穿透，预热，降级

- 1.__缓存雪崩:__  缓存同一时间大面积失效，导致的大量请求落到数据库上，造成数据库短时间内承受大量的请求而崩掉

  __解决方案:__

  + 缓存数据过期时间设置随机，防止同一时间大量数据过期现象发生
  + 并发不是特别多的时候，使用__加锁排队__
  + 给缓存数据增加缓存标记，记录是否失效，失效则更新数据缓存

- 2.__缓存穿透:__缓存和数据库中都没有数据，导致所有请求都落到数据库上，造成数据库短时间内承受大量请求而崩掉

  __解决方案__

  - 接口层增加校验，如用户鉴权校验，id做基础校验，id<=0的直接拦截
  - 在缓存和数据库中都取不到数据的情况下，可以将key-value对写成key-null，缓存有效时间设置短一点(设置太长会导致正常情况也没法使用)，以此来防止重复id的暴力攻击
  - 采用__布隆过滤__，将所有可能存在的数据哈希到一个足够大的bitmap中，一个一定不存在的数据会被这个bitmap拦截掉

- 3.__缓存击穿：__缓存中没有，但数据库中有（缓存到期），由于并发用户特别多，同时读取缓存没读到数据，又同时去数据库取数据，造成的数据库压力瞬间增大。和缓存雪崩不同的是，缓存击穿指并发查同一条数据，缓存雪崩是不同数据同时过期了，缓存查不到，而去查数据库。

  __解决方案__

  - 设置热点数据用不过期
  - 加__互斥锁__

- 4.__缓存预热:__系统上线后,将相关的缓存数据直接家在到缓存系统，避免用户在请求是先查数据库，在缓存到缓存

  __解决方案__

  - 直接写个缓存刷新页面，上线后手工操作一下
  - 数据量不大的情况下，可以再项目启动时自动进行加载
  - 定时刷新缓存

- 5.__缓存降级:__在不影响核心服务和核心流程性能的同时，对不重要的缓存数据才去服务降级策略，例如：Redis出现问题时，不去数据库查询，直接返回默认值给用户。最终目的，为了防止Redis服务故障，导致的数据库跟着发生雪崩

##  5、Redis集群
Redis 集群会将用户数据分散保存到各个节点中，集群引入了哈希槽slot,搭建完成后会生成16384个哈希槽slot,同时会根据节点数量大致均等的将16384个哈希槽映射到不同的节点上。当用户存储key-value时，集群会先对key进行CRC16校验，然后对16384取模来决定key-value存储在哪个槽。
Redis是一个网状结构，每个节点都通过TCP连接跟其他每个节点连接，Redis客户端可以直接连接任何一个节点获取集群中的键值对，不需要中间代理，如果该节点不存在用户指定的键值，其内部会自动把客户端重定向到键值所在的节点。

Redis Cluster 支持主从复制和故障恢复。集群使用主从复制模型，每个主节点应至少有一个从节点。某个主节点故障时，所有子节点会广播一个数据包给集群中其他主节点来请求选票，收到大多数主节点回应的节点将赢得选举被选为主节点。

Redis集群至少需要3个主节点，二每个主节点至少有1个从节点，一个集群至少包含6个节点，3主3从。
